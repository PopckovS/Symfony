##SQL Урок 5

### !!! с NULL ничего сравнивать нельзя !!!

####1.Вычисляемые поля
В случаем если нам требуются данные которых нет в чистом виде, которые могут быть 
сформированы путем обьеденения нескольких полей.

Конкатенация происходит указанием оператора `||`  

    SELECT vend_name || '(' || vend_country || ')'
    FROM Vendors
    ORDER BY vend_name;

RTRIM()  - отбрасывает все пробелы с лева.
Concat() - В некотрых СУБД требуется обьеденять вычисляемые поля при помощи
функции конкаьтенации, в такой функции не требуется указывать оператор 
обьеденения `||`

    SELECT Concat(RTRIM(vend_name), '(', RTRIM(vend_country),')')
    FROM Vendors
    ORDER BY vend_name;

    // Ответ
    Bear Emporium(USA)
    Bears R Us(USA)

Также можно изымать поля давая им при выводе другое название, к примеру так:

    SELECT Concat(RTRIM(vend_name), '(', RTRIM(vend_country),')') AS result_title

Также можно в выборке SELECT указывать весь набор математических операций. 

####2.Использование функций обработки данных

    UPPER()  перобразует в верх регистр.

    LENGTH() возвращает длину строки
    LEN()
    
    LOWER() в нижний регистр
    LCASE()
    
    LTRIM() удаляет пробелы в левой

    RTRIM() удаляет пробелы в правой
    
    to_char()
    to_number()
    to_date()
    
    YEAR() возвращает год из даты

    ABS() модуль числа
    

####3.Агрегатные функции, Итоговые вычисления
Такие функции используются для анализа данных и создания запросов.

1. Подсчет числа строк в табл,ли число строк удовл некотр условию.
2. Определение суммы по набору строк.
3. ПОиск наиб ним и сред значения.

В каждой подобной выборке, мы получаем итоговые значения а не чистые данные.
Есть 5 итоговых функций.

    AVG()   - среднее значение по столбцу
    COUNT() - число строк в табл 
    MAX()   - наиб значение по столбцу
    MIN()   - наимен знач по столбцу
    SUM()   - сумма значений столбца

COUNT(*) подсчте всех строк вместе с NULL.
COUNT(столбец) подсчет строк в указанном столбце и без учета NULL.

    SELECT AVG(prod_price) AS avprice
    FROM Products;

    SELECT AVG(prod_price) AS avg_price
    FROM Products
    WHERE vend_id = 'DLL01';

    // Узнать число строк COUNT() всего в таблице
    SELECT COUNT(*) AS num_cust
    FROM Customers;
        
        //Ответ    
        5

    // Подсчитать колич строк в столбце без учета тех в которых значение = NULL
    SELECT COUNT(cust_email) AS num_cust
    FROM Customers;

        //Ответ
        3

####4.Итоговые вычисления для уникальных значений
Все 5 итоговых функций могут быть использованы 2 разными способами.

1) Либо для вычисления по всем строкам,ри помощи ALL или без него ибо он исп по умолчанию.
2) Для вычисления по уникальным значениям при наличии ключевого слова DISTINCT.

    
    // Подсчет среднего арифмет только среди уникальных значений, там где поставщик это DLL01  
    SELECT  AVG(DISTINCT  Products.prod_price)
    FROM Products
    WHERE Products.vend_id = 'DLL01';


####5.Комбинирование Итоговых функций.
Получим все по всем полям, количество строк вабще,ин и макс и среднее значение поценам.

    SELECT COUNT(*),
		 MIN(prod_price),
		 MAX(prod_price),
		 AVG(prod_price)
    FROM Products;




##6.ГРУППИРОВКА ДАННЫХ: GROUP BY, HAVING.
Агрегатные функции для подсчета, применялись над всеми данными, которые соответствовали 
условию WHERE. К примеру подсчитать общее количество строк у которых поставщик это `DLL01`

    SELECT COUNT(*)
    FROM Products 
    WHERE vend_id = 'DLL01';
    
        //Ответ 
        4

Этут запрос работает, но он считате количество записей именно для 1 поставщика, а что 
если мы хотим узнать количество строк для всех поставщиков в таблице.

Именно для таких целей и выступает группировка, она позволяет какбы розделить все строки 
на подмассивы, где в каждом подмасиве содержиатся данные соответствующие определенному условию.
А после можно провести вычисления отдельно по каждой группе.

Группы создаются при помощи `GROUP BY`. 

Сгрупируем все записи по проставщикам, выводом количества записей в таблице для каждого 
из поставщиков.

    SELECT vend_id, COUNT(*)           SELECT vend_id
    FROM Products                      FROM Products
    GROUP BY vend_id;                  GROUP BY vend_id;

        // Ответ                       // Ответ
        BRS01  3                       BRS01
        DLL01  4                       DLL01
        FNG01  2                       FNG01

Правила использования `GROUP BY`:

1) Каждый столбец указанный в GROUP BY должен быть извлекаемым столбцом или выражением.
   Если что то используется в SELECT то оно должно быть и в GROUP BY. За исключением 
   функций агрегирования. Тоесть все что есть в GROUP BY должно быть и в SELECT кроме 
   агрегатных функций.
2) Если столбец содержит NULL то этот отдельный тип будет сгруппирован в отдельную группу.
3) GROUP BY должно стоять после WHERE но перед ERDER BY.


    SELECT / GROUP BY / WHERE / ORDER BY

####7.Фильтрация по Группам HAVING
Можно не только группировать данные но и фильтровать их. Инструкцию WHERE использовать 
нельзя ибо она касается строк а не групп. Для этого используется HAVING фильтрация по группам.
Все то что характерно для WHERE аналогично действует и для HAVING.

    // Изьять все записи из столбца cust_id
    SELECT cust_id
    FROM Orders;

        // Ответ
        1000000001
        1000000001
        1000000003
        1000000004
        1000000005


    // Изьять все cust_id и по нимже сгруппировать
    SELECT Orders.cust_id
    FROM Orders
    GROUP BY cust_id;

        // Ответ
        1000000001
        1000000003
        1000000004
        1000000005


    // Сгруппировать по cust_id и подсчитать колличество записей в каждой группировке
    // и вывести только тех клиентов которые сделалти более двух заказов.
    SELECT Orders.cust_id, COUNT(*)
    FROM Orders
    GROUP BY cust_id
    HAVING COUNT(*)>=2;

        // Ответ
        1000000001  2

####8.Использование WHERE и HAVING вместе.
Вернуть всех поставщиков которые предлагают не менее 2 товаров за 4 доллара и более за еденицу.

    SELECT vend_id, COUNT(*)
    FROM Products
    WHERE prod_price >= 4
    GROUP BY vend_id
    HAVING COUNT(*) >= 2;

    // Ответ
    BRS01   3
    FNG01   2

WHERE изымает данные а уже потом GROUP BY их группирует.









